# Deploy to Digital Ocean App Platform

This guide walks you through deploying the Racing Life backend to Digital Ocean App Platform.

## Prerequisites

- Digital Ocean account with $200 credit
- GitHub repository connected to your Digital Ocean account
- Environment variable values (JWT_SECRET, API keys, etc.)

## Cost Estimate

With the current configuration:

- **App Service (API)**: ~$5/month (basic-xxs: 512MB RAM)
- **PostgreSQL Database**: ~$15/month (dev tier) or $25/month (production)
- **Redis**: ~$15/month (dev tier) or $25/month (production)
- **Total**: ~$35-55/month (with $200 credit = 3-6 months free)

## Deployment Steps

### 1. Push Code to GitHub

```bash
git add backend/.do/app.yaml backend/DEPLOY_DIGITALOCEAN.md
git commit -m "Add Digital Ocean deployment configuration"
git push
```

### 2. Create App on Digital Ocean

1. Go to https://cloud.digitalocean.com/apps
2. Click **"Create App"**
3. Choose **"GitHub"** as source
4. Select your repository: **chiefgu/racing-life**
5. Choose branch: **main**
6. Click **"Next"**

### 3. Configure from Spec File

1. Digital Ocean will detect the `.do/app.yaml` spec file
2. Click **"Use this app spec"**
3. Review the configuration:
   - API service
   - PostgreSQL database
   - Redis database

### 4. Set Environment Variables

In the Digital Ocean dashboard, set these **SECRET** environment variables:

**Required:**

- `JWT_SECRET`: Generate with `openssl rand -base64 32`
- `DATABASE_URL`: Auto-generated by DO when you add the database
- `REDIS_URL`: Auto-generated by DO when you add Redis

**Optional (for full functionality):**

- `OPENAI_API_KEY`: Your OpenAI API key
- `THE_ODDS_API_KEY`: Your The Odds API key
- `FIREBASE_PROJECT_ID`: Your Firebase project ID
- `FIREBASE_PRIVATE_KEY`: Your Firebase private key
- `FIREBASE_CLIENT_EMAIL`: Your Firebase client email
- `SENTRY_DSN`: Your Sentry DSN (for error tracking)

### 5. Update CORS Origin

After deployment, update the `CORS_ORIGIN` environment variable with your actual Vercel frontend URL.

### 6. Deploy

1. Click **"Create Resources"**
2. Wait for deployment (5-10 minutes)
3. Digital Ocean will:
   - Build the Docker image
   - Create PostgreSQL database
   - Create Redis instance
   - Run database migrations
   - Start the application

### 7. Get Your Backend URL

After deployment completes, you'll get a URL like:

```
https://racing-life-backend-xxxxx.ondigitalocean.app
```

### 8. Update Frontend (Vercel)

Add environment variable to your Vercel project:

1. Go to https://vercel.com/henry-gs-projects/frontend/settings/environment-variables
2. Add new variable:
   - Name: `NEXT_PUBLIC_API_URL`
   - Value: `https://your-backend-url.ondigitalocean.app/api`
3. Redeploy frontend

### 9. Test

Test registration at: `https://your-frontend.vercel.app/onboarding`

## Monitoring

- **Logs**: View in Digital Ocean console under your app
- **Metrics**: CPU, Memory, Network usage in DO dashboard
- **Health Check**: Available at `https://your-backend-url/health`

## Troubleshooting

### Build fails

- Check Dockerfile is correct
- Ensure all dependencies are in package.json

### Database connection fails

- Verify DATABASE_URL is set correctly
- Check database is in same region as app

### Redis connection fails

- Verify REDIS_URL is set correctly
- Ensure Redis is created and running

### Migrations fail

- Check migration files are copied in Dockerfile
- Verify knexfile.ts is accessible

## Scaling

To handle more traffic:

1. Increase instance size (basic-xs, basic-s, etc.)
2. Increase instance count for load balancing
3. Upgrade database to production tier

## Cost Optimization

For development:

- Use `production: false` for database and Redis (dev tier)
- Use smallest instance size (basic-xxs)
- Scale up only when needed
