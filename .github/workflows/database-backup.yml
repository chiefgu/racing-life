name: Database Backup

on:
  schedule:
    # Daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  backup:
    name: Backup Production Database
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-15
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'ap-southeast-2' }}
      
      - name: Create backup directory
        run: mkdir -p /tmp/backups
      
      - name: Run database backup
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT || '5432' }}
          DB_NAME: ${{ secrets.DB_NAME || 'horse_racing' }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          S3_BUCKET: ${{ secrets.S3_BACKUP_BUCKET }}
          S3_PREFIX: backups/production
          BACKUP_DIR: /tmp/backups
          RETENTION_DAYS: 30
        run: |
          chmod +x backend/scripts/backup-database.sh
          ./backend/scripts/backup-database.sh
      
      - name: Verify backup
        run: |
          LATEST_BACKUP=$(ls -t /tmp/backups/horse_racing_backup_*.sql.gz | head -1)
          if [ -f "$LATEST_BACKUP" ]; then
            echo "‚úÖ Backup created: $LATEST_BACKUP"
            echo "üì¶ Size: $(du -h $LATEST_BACKUP | cut -f1)"
            gzip -t "$LATEST_BACKUP" && echo "‚úÖ Backup integrity verified"
          else
            echo "‚ùå Backup file not found!"
            exit 1
          fi
      
      - name: Send success notification
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '‚úÖ Database backup completed successfully',
              attachments: [{
                color: 'good',
                fields: [{
                  title: 'Environment',
                  value: 'Production',
                  short: true
                }, {
                  title: 'Timestamp',
                  value: '${{ github.event.head_commit.timestamp }}',
                  short: true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
      
      - name: Send failure notification
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '‚ùå Database backup failed!',
              attachments: [{
                color: 'danger',
                fields: [{
                  title: 'Environment',
                  value: 'Production',
                  short: true
                }, {
                  title: 'Workflow',
                  value: '${{ github.workflow }}',
                  short: true
                }, {
                  title: 'Run',
                  value: '<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>',
                  short: false
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  test-restore:
    name: Test Backup Restore
    runs-on: ubuntu-latest
    needs: backup
    if: github.event.schedule == '0 2 1 * *'  # Monthly on the 1st
    
    services:
      postgres:
        image: timescale/timescaledb:latest-pg15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-15
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'ap-southeast-2' }}
      
      - name: Download latest backup
        run: |
          mkdir -p /tmp/backups
          aws s3 cp s3://${{ secrets.S3_BACKUP_BUCKET }}/backups/production/ /tmp/backups/ \
            --recursive \
            --exclude "*" \
            --include "horse_racing_backup_*.sql.gz" \
            | tail -1
      
      - name: Create test database
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE DATABASE horse_racing_test;"
          PGPASSWORD=postgres psql -h localhost -U postgres -d horse_racing_test -c "CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;"
      
      - name: Restore backup to test database
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: horse_racing_test
          DB_USER: postgres
          DB_PASSWORD: postgres
          BACKUP_DIR: /tmp/backups
        run: |
          chmod +x backend/scripts/restore-database.sh
          LATEST_BACKUP=$(ls -t /tmp/backups/horse_racing_backup_*.sql.gz | head -1)
          echo "yes" | ./backend/scripts/restore-database.sh $(basename $LATEST_BACKUP)
      
      - name: Verify restored data
        run: |
          echo "Checking table counts..."
          PGPASSWORD=postgres psql -h localhost -U postgres -d horse_racing_test -c "
            SELECT 
              schemaname,
              tablename,
              pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
            FROM pg_tables
            WHERE schemaname = 'public'
            ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
            LIMIT 10;
          "
          
          echo "Verifying critical tables exist..."
          PGPASSWORD=postgres psql -h localhost -U postgres -d horse_racing_test -c "
            SELECT COUNT(*) as race_count FROM races;
            SELECT COUNT(*) as user_count FROM users;
            SELECT COUNT(*) as bookmaker_count FROM bookmakers;
          "
      
      - name: Send test results
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '${{ job.status == 'success' && '‚úÖ' || '‚ùå' }} Monthly backup restore test ${{ job.status }}',
              attachments: [{
                color: '${{ job.status == 'success' && 'good' || 'danger' }}',
                fields: [{
                  title: 'Test Type',
                  value: 'Backup Restore Verification',
                  short: true
                }, {
                  title: 'Result',
                  value: '${{ job.status }}',
                  short: true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
